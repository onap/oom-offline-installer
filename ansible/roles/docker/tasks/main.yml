---
- name: Install docker
  package:
    name: 'docker-ce'
    state: present
  notify:
    - Restart Docker

- name: Install docker python module
  package:
    name: 'python2-docker'
    state: present

- name: Ensure /etc/docker exists
  file:
    path: /etc/docker
    state: directory

- name: Setup docker container logging settings
  json_mod:
    path: /etc/docker/daemon.json
    key: '' # the whole JSON document per https://tools.ietf.org/html/rfc6901
    action: append
    # unfortunately, it must be wrapped in jinja otherwise ansible/python2 will choke on it
    value: "{{ { \"log-driver\": \"json-file\", \"log-opts\": { \"max-size\": \"{{ docker.log_max_size }}\", \"max-file\": \"{{ docker.log_max_file }}\" } } | to_json }}"

- name: Setup docker dns settings
  json_mod:
    path: /etc/docker/daemon.json
    key: dns
    action: replace
    # unfortunately, it must be wrapped in jinja otherwise ansible/python2 will choke on it
    value: "{{ [ \"{{ hostvars[groups.infrastructure[0]].cluster_ip }}\" ] | to_json }}"
  notify:
    - Restart Docker

- name: Force notified handlers to run at this point
  meta: flush_handlers

- name: Ensure docker is started
  systemd:
    name: docker
    state: started
    enabled: yes
