---
- name: Install docker
  package:
    name: 'docker-ce'
    state: present
  notify:
    - Restart Docker

- name: Install docker python module
  package:
    name: 'python2-docker'
    state: present

- name: Ensure /etc/docker exists
  file:
    path: /etc/docker
    state: directory

- name: Resolve the ansible_host address to ip
  shell: LANG=C ping -n -c1 "{{ hostvars[groups.infrastructure[0]].ansible_host }}" | sed -n 1p | cut -d' ' -f3 | tr -d '()'
  register: infra_ipv4

- name: Setup docker dns settings
  json_add:
    path: /etc/docker/daemon.json
    key: dns
    value: "{{ infra_ipv4.stdout }}"
  notify:
    - Restart Docker

- name: Force notified handlers to run at this point
  meta: flush_handlers

- name: Ensure docker is started
  systemd:
    name: docker
    state: started
    enabled: yes
