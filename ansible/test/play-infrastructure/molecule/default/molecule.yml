---
dependency:
  name: galaxy
driver:
  name: docker
lint:
  name: yamllint
platforms:
  - name: infrastructure-server
    image: molecule-${PREBUILD_PLATFORM_DISTRO:-centos}:${PREBUILD_DISTRO_VERSION:-centos7.6}
    pre_build_image: true
    privileged: true
    override_command: false
    restart_policy: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${APP_DATA_PATH}:${APP_DATA_PATH}
      - ${APP_DATA_PATH}/certs:/etc/nginx/certs:ro
      - ${APP_DATA_PATH}/git-repo:/srv/git:rw
      - ${APP_DATA_PATH}/http:/srv/http:rw
      - ${APP_DATA_PATH}/pkg/rhel:/srv/http/repo.infra-server/rhel:rw
      - ${APP_DATA_PATH}/pkg/ubuntu/xenial:/srv/http/repo.infra-server/ubuntu/xenial:rw
      - /var/log/nginx:/var/log/nginx:rw
    groups:
      - infrastructure
    # By design certain file like /etc/resolv.conf cannot be edited in docker
    # container. To enable role to "edit" /etc/resolv.conf define value already to same.
    dns_servers:
      - 8.8.8.8  # to preserve dns resolution for prepare steps
      - 6.5.4.3  # for package-repository role need to match with cluster-ip
      # Enable etc_host when https://github.com/ansible/molecule/pull/1974 available in molecule.
      # etc_hosts:
      #   nexus.infrastructure-server: 172.17.0.1
      #   nexus3.onap.org: 172.17.0.1

  - name: kubernetes-node-1
    image: molecule-${PREBUILD_PLATFORM_DISTRO:-centos}:${PREBUILD_DISTRO_VERSION:-centos7.6}
    pre_build_image: true
    privileged: true
    override_command: false
    restart_policy: unless-stopped
    groups:
      - kubernetes
    # By design certain file like /etc/resolv.conf cannot be edited in docker
    # container. To enable role to "edit" /etc/resolv.conf define value already to same.
    dns_servers:
      - 8.8.8.8  # to preserve dns resolution for prepare steps
      - 6.5.4.3  # for package-repository role need to match with cluster-ip

provisioner:
  name: ansible
  log: true
  playbooks:
    # Create playbooks explicitly mentioned here as it's needed for etc_hosts definition.
    # Remove this playbook section and custom create.yml file when Molecule version
    # used where this change is included: https://github.com/ansible/molecule/pull/1974
    create: create.yml
  env:
    ANSIBLE_ROLES_PATH: ../../../roles:../../../../roles/
    ANSIBLE_LIBRARY: ../../../../library
  inventory:
    # NOTE: Cannot use molecule-dev container for this test as it includes host docker restart that kills the runner!
    host_vars:
      infrastructure-server:
        cluster_ip: 6.5.4.3
      localhost:
        # Provide passwords in env variable file .env.yml on role directory or as molecule command line option (--env-file).
        ansible_sudo_pass: ${LOCALHOST_ANSIBLE_SUDO_PASS:-""}
        ansible_ssh_pass: ${LOCALHOST_ANSIBLE_PASSWORD:-""}
  lint:
    name: ansible-lint
scenario:
  name: default
  test_sequence:
    # TODO: temporarily disable linting
    #- lint
    - cleanup
    - destroy
    - dependency
    - syntax
    - create
    - prepare
    - converge
    # - idempotence
    # --> Action: 'idempotence'
    # ERROR: Idempotence test failed because of the following tasks:
    # * [infrastructure-server -> 10.0.2.15] => certificates : Generate an OpenSSL CSR.
    # * [infrastructure-server -> 10.0.2.15] => certificates : Generate root CA certificate
    - side_effect
    - verify
    - cleanup
    - destroy
verifier:
  name: testinfra
  lint:
    name: flake8
